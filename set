#!/bin/bash
set -e

# directories
TOP_DIR="$( cd "$( dirname "$BASH_SOURCE" )" && pwd -P )"

usage() {
	echo "Usage: $(basename $0) [--help] [--target=<env>]"
	echo ""
	echo "	===== options ====="
	echo "	--help: print usage"
	echo "	--target=<env>: select setting env"
	echo "	==================="
	echo ""
	echo "	e.g. setting \"vi\" env"
	echo ""
	echo "	$ cd workspace"
	echo "	$ ./set --target=vi"
	exit 0
}

# option parsing
for opt in $@; do
	case ${opt} in
		--help)
		usage
		;;
		--mode=*)
		parse=${opt#*=}
			case ${parse} in
			[nN][oO][mM][aA][lL]|[nN])
			MODE=normal
			;;
			[aA][dD][dD]|[aA])
			MODE=add
			;;
			esac
		;;
		--speed=*)
		SPEED=${opt#*=}
		;;
		--target=*)
		TARGET=${opt#*=}
		;;
		*)
		echo "Invalid option"
		;;
	esac
done

# includes
. ${TOP_DIR}/time
. ${TOP_DIR}/prefix
. ${TOP_DIR}/functions

# default options
[ -z ${MODE} ] && MODE="normal"
[ -z ${SPEED} ] && SPEED="1"
[ -z ${TARGET} ] && TARGET="vi"

run() {
	local list=""
	local prog=""

	fix_env
	setup

	for idx in "${SRT_DIR[@]}"; do
		[ $(find ${idx} -type f | wc -l) != 0 ] \
			&& sudo cp ${idx}/* ${SET_SRT_DIR}
	done

	list=($(ls -A1 ${SET_SRT_DIR}))
	for idx in "${list[@]}"; do
		prog=${idx%%-*}
		prog=${prog:1:2}
		echo "processing... ${prog}%"
		. ${SET_SRT_DIR}/${idx}
		sleep ${SPEED}
	done
}

# remove install directory
[ -d ${INSTALL_DIR} ] && rm -rf ${INSTALL_DIR}

run
